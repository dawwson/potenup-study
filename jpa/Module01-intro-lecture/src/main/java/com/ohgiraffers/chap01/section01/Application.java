package com.ohgiraffers.chap01.section01;

import com.ohgiraffers.chap01.section01.model.Roles;
import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

/*
 * ê°ì²´ì§€í–¥(OOP)ê³¼ RDBì˜ íŒ¨ëŸ¬ë‹¤ìž„ ì°¨ì´: ë™ì¼ ë°ì´í„°ì˜ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ì™€ ë¬´ê²°ì„± ë¬¸ì œ
 *
 * `Application` í´ëž˜ìŠ¤ëŠ” ê°ì²´ì§€í–¥ í”„ë¡œê·¸ëž˜ë°ì—ì„œ RDBì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬ `Roles` ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
 * ê°ì²´ì§€í–¥ì—ì„œëŠ” ë™ì¼í•œ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ê°€ ë™ì¼í•œ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬ë˜ê¸°ë¥¼ ê¸°ëŒ€í•œë‹¤.
 * ì˜ˆë¥¼ ë“¤ì–´, ë™ì¼í•œ `roleId`ë¥¼ ê°€ì§„ `Roles` ê°ì²´ëŠ” ë™ì¼í•œ ê°ì²´ë¡œ ê°„ì£¼ë˜ì–´ì•¼ í•˜ë©°, `roles == roles2`ê°€ `true`ë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
 * ì´ëŠ” ê°ì²´ ì‹ë³„ì„±(Identity)ê³¼ ê´€ë ¨ì´ ìžˆë‹¤.
 *
 * ë°˜ë©´, ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤(RDB)ì—ì„œëŠ” ë™ì¼í•œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë”ë¼ë„ ë§¤ë²ˆ ìƒˆë¡œìš´ ë°ì´í„° í–‰(row)ì„ ë°˜í™˜í•œë‹¤.
 * `getRoles` ë©”ì„œë“œëŠ” ë™ì¼í•œ `roleId`ë¡œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ `Roles` ê°ì²´ë¥¼ ìƒì„±í•˜ë¯€ë¡œ,
 * `roles`ì™€ `roles2`ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì¸ì‹ëœë‹¤.
 *
 * ë”°ë¼ì„œ, ê°ì²´ì§€í–¥ì—ì„œëŠ” ë™ì¼í•œ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ë¥¼ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬í•˜ë ¤ëŠ” ê²½í–¥ì´ ìžˆë‹¤.
 * RDBì—ì„œëŠ” ë°ì´í„°ë¥¼ í–‰ ë‹¨ìœ„ë¡œ ì¡°íšŒí•˜ì—¬ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë°©ì‹ì´ ì¼ë°˜ì ì´ë‹¤.
 * ì´ ì°¨ì´ëŠ” ê°ì²´ì§€í–¥ê³¼ RDBì˜ íŒ¨ëŸ¬ë‹¤ìž„ ì°¨ì´ë¥¼ ë³´ì—¬ì¤€ë‹¤.
 *
 * ðŸ“Œ ë¬´ê²°ì„±(Integrity) ë¬¸ì œ: ë™ì¼ ë°ì´í„°ì˜ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì¸í•œ ìˆ˜ì • ë°˜ì˜ ë¬¸ì œ
 * RDBì—ì„œëŠ” ë™ì¼í•œ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ ë²ˆ ì¡°íšŒí•˜ë”ë¼ë„ ë™ì¼í•œ ë°ì´í„° í–‰(row)ì„ ë°˜í™˜í•˜ë©°, ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ìž¥í•œë‹¤.
 * ì˜ˆë¥¼ ë“¤ì–´, `Roles` í…Œì´ë¸”ì—ì„œ `role_id=1`ì¸ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë©´ í•­ìƒ ë™ì¼í•œ ë°ì´í„°ê°€ ë°˜í™˜ëœë‹¤.
 * ê·¸ëŸ¬ë‚˜ `getRoles` ë©”ì„œë“œëŠ” ë™ì¼í•œ `roleId`ë¡œ ì¡°íšŒí•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ `Roles` ê°ì²´ë¥¼ ìƒì„±í•˜ë¯€ë¡œ,
 * ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤(ì˜ˆ: A ì¸ìŠ¤í„´ìŠ¤ì™€ B ì¸ìŠ¤í„´ìŠ¤)ê°€ ë§Œë“¤ì–´ì§„ë‹¤.
 * ì´ë¡œ ì¸í•´ ë¬´ê²°ì„± ë¬¸ì œê°€ ë°œìƒí•œë‹¤:
 * - A ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ì—¬ `roleName`ì„ "Admin"ìœ¼ë¡œ ìˆ˜ì •í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•œ í›„,
 *   ë™ì¼í•œ `roleId`ë¡œ B ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ë©´ B ì¸ìŠ¤í„´ìŠ¤ëŠ” Aì˜ ìˆ˜ì • ì‚¬í•­ì„ ë°˜ì˜í•˜ì§€ ì•ŠëŠ”ë‹¤.
 * - ì´í›„ B ì¸ìŠ¤í„´ìŠ¤ë¥¼ `roleName`ì„ "User"ë¡œ ìˆ˜ì •í•˜ê³  ì €ìž¥í•˜ë©´, A ì¸ìŠ¤í„´ìŠ¤ì˜ ìˆ˜ì • ì‚¬í•­ì´ ë®ì–´ì”Œì›Œì ¸ ë°ì´í„° ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•œë‹¤.
 *
 * ðŸ“Œ ë™ì‹œì„± ë¬¸ì œ(Concurrency Issue)ì™€ì˜ ê´€ë ¨ì„±
 * ìœ„ ë¬¸ì œëŠ” ë™ì‹œì„± ë¬¸ì œë¡œ í™•ìž¥ë  ìˆ˜ ìžˆë‹¤:
 * - ë™ì¼í•œ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤(Aì™€ B)ë¡œ ê´€ë¦¬í•˜ëŠ” ìƒí™©ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë‚˜ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ë™ì¼í•œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•  ë•Œ ë™ì‹œì„± ë¬¸ì œë¥¼ ìœ ë°œí•œë‹¤.
 * - ì˜ˆë¥¼ ë“¤ì–´, ìŠ¤ë ˆë“œ 1ì´ A ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ì—¬ `roleName`ì„ "Admin"ìœ¼ë¡œ ìˆ˜ì •í•˜ëŠ” ë™ì•ˆ,
 *   ìŠ¤ë ˆë“œ 2ê°€ B ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ì—¬ `roleName`ì„ "User"ë¡œ ìˆ˜ì •í•˜ë©´, ë‘ ìŠ¤ë ˆë“œê°€ ì„œë¡œì˜ ë³€ê²½ ì‚¬í•­ì„ ë®ì–´ì“°ê²Œ ëœë‹¤.
 *   ì´ëŠ” ì „í˜•ì ì¸ **"Lost Update"** ë¬¸ì œì´ë‹¤.
 * - í˜„ìž¬ ì½”ë“œì—ì„œëŠ” ë‹¨ì¼ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë™ìž‘í•˜ì§€ë§Œ, ë™ì¼ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬í•˜ëŠ” ì„¤ê³„ ìžì²´ê°€ ë™ì‹œì„± í™˜ê²½ì—ì„œ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ê°€ëŠ¥ì„±ì„ ë‚´í¬í•˜ê³  ìžˆë‹¤.
 *
 * ðŸ“Œ ì¶”ê°€ ë¬¸ì œ: SQL ì˜ì¡´ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±
 * `getRoles` ë©”ì„œë“œ ë‚´ì—ì„œ SQL ì¿¼ë¦¬ì— ì§ì ‘ ì˜ì¡´í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°íšŒí•œë‹¤.
 * ì´ëŠ” ê°ì²´ì§€í–¥ ì½”ë“œê°€ RDBì˜ ìŠ¤í‚¤ë§ˆì™€ ì¿¼ë¦¬ì— ê°•í•˜ê²Œ ê²°í•©ë˜ì–´ ìš”êµ¬ì‚¬í•­ ë³€ê²½ ì‹œ SQL ìˆ˜ì •ì´ í•„ìš”í•˜ë‹¤.
 * ì˜ˆë¥¼ ë“¤ì–´, `Roles` í…Œì´ë¸”ì— ìƒˆë¡œìš´ ì»¬ëŸ¼ì´ ì¶”ê°€ë˜ê±°ë‚˜ ì»¬ëŸ¼ ì´ë¦„ì´ ë³€ê²½ë˜ë©´, `getRoles` ë©”ì„œë“œì˜ ì¿¼ë¦¬ì™€ ê°ì²´ ë§¤í•‘ ì½”ë“œë„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.
 * ì´ëŠ” ìœ ì§€ë³´ìˆ˜ì„±ì„ ì €í•˜ì‹œí‚¤ê³  ì˜¤ë¥˜ ê°€ëŠ¥ì„±ì„ ë†’ì¸ë‹¤.
 * ë˜í•œ, ê°ì²´ë¥¼ ì‚¬ìš©í•  ë•Œ SQL ì¿¼ë¦¬ë¥¼ í™•ì¸í•´ì•¼ ê°ì²´ì— ì–´ë–¤ ê°’ì´ ë“¤ì–´ìžˆëŠ”ì§€ ì•Œ ìˆ˜ ìžˆë‹¤.
 *
 * ì´ëŸ¬í•œ ì°¨ì´ë¡œ ì¸í•´ ì„¤ê³„ì™€ êµ¬í˜„ì—ì„œ í˜¼ëž€ì´ ë°œìƒí•  ìˆ˜ ìžˆë‹¤:
 * - ê°ì²´ì§€í–¥ ê´€ì : ë™ì¼í•œ `roleId`ë¥¼ ê°€ì§„ `Roles` ê°ì²´ëŠ” ë™ì¼í•œ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê°„ì£¼ë˜ì–´ì•¼ í•˜ë©°, ë¹„êµ ì‹œ `==`ë¡œ ë™ì¼ì„±ì„ í™•ì¸í•  ìˆ˜ ìžˆì–´ì•¼ í•œë‹¤.
 * - RDB ê´€ì : ë™ì¼í•œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë”ë¼ë„ ë§¤ë²ˆ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•˜ë¯€ë¡œ, `roles == roles2`ê°€ `false`ë¡œ í‰ê°€ëœë‹¤.
 *   ì´ë¡œ ì¸í•´ ë™ì¼ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬í•˜ì—¬ ìˆ˜ì • ì‹œ ë°ì´í„° ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.
 * ì´ë¡œ ì¸í•´ ë™ì¼í•œ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ê°€ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬ë˜ì–´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.
 * ë˜í•œ, ë™ì‹œì„± í™˜ê²½ì—ì„œëŠ” ì´ëŸ¬í•œ ë¬¸ì œê°€ ë” ì‹¬í™”ë˜ì–´ ë°ì´í„° ë¬´ê²°ì„±ì´ ê¹¨ì§ˆ ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§„ë‹¤.
 * ì˜ˆë¥¼ ë“¤ì–´, ë™ì¼í•œ ê¶Œí•œ ê°ì²´ë¥¼ ì—¬ëŸ¬ ë²ˆ ì¡°íšŒí•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ë©´ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ì¦ê°€í•˜ê³ ,
 * ê°ì²´ ë¹„êµ ì‹œ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ê°€ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.
 *
 * ì´ ì°¨ì´ëŠ” íŠ¹ì • ì´ë²¤íŠ¸ì˜ ì£¼ì²´ì™€ ë™ìž‘ì„ ì´í•´í•˜ëŠ” ë° í˜¼ëž€ì„ ì´ˆëž˜í•  ìˆ˜ ìžˆë‹¤:
 * EX) ë™ì¼ ê¶Œí•œ ë¹„êµ: ê°ì²´ì§€í–¥ì—ì„œëŠ” `roles == roles2`ë¡œ ë™ì¼ì„±ì„ í™•ì¸í•˜ë ¤ í•˜ì§€ë§Œ, RDBì—ì„œëŠ” ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ì–´ ë¹„êµ ì‹¤íŒ¨.
 * EX) ê¶Œí•œ ìºì‹±: ë™ì¼í•œ ê¶Œí•œ ê°ì²´ë¥¼ ìºì‹±í•˜ì—¬ ìž¬ì‚¬ìš©í•˜ë ¤ í•˜ì§€ë§Œ, ë§¤ë²ˆ ìƒˆë¡œìš´ ê°ì²´ê°€ ìƒì„±ë˜ì–´ ìºì‹± íš¨ê³¼ ìƒì‹¤.
 * EX) ê¶Œí•œ ìˆ˜ì •: A ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ê¶Œí•œ ì´ë¦„ì„ ìˆ˜ì •í•œ í›„, B ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë™ì¼ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë©´ Aì˜ ë³€ê²½ ì‚¬í•­ì´ ì†ì‹¤ëœë‹¤.
 * EX) ë™ì‹œ ìˆ˜ì •: ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì¼ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•˜ë©´ "Lost Update" ë¬¸ì œë¡œ ë°ì´í„° ë¬´ê²°ì„±ì´ ê¹¨ì§„ë‹¤.
 */
public class Application {
    private static final HikariDataSource dataSource;

    static {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/JPA_LECTURE");
        config.setUsername("root");
        config.setPassword("1234");
        dataSource = new HikariDataSource(config);
    }

    /*
     * [1ë‹¨ê³„ ë¬¸ì œ]
     * ë¬¸ì œ ìƒí™©:
     * ìš°ë¦¬ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ IDê°€ 1ì¸ "í•™ìƒ" ì—­í• ì„ ë‘ ë²ˆ ì¡°íšŒí–ˆë‹¤.
     * ìš°ë¦¬ì˜ ìƒì‹ìœ¼ë¡œëŠ” "roles"ì™€ "roles2"ëŠ” ê°™ì€ ì—­í• ì´ë¯€ë¡œ, ë‘ ê°ì²´ëŠ” ë™ì¼í•´ì•¼ í•œë‹¤.
     * í•˜ì§€ë§Œ ê²°ê³¼ëŠ” "false"ê°€ ë‚˜ì˜¤ê²Œ ëœë‹¤.
     *
     * ë¬¸ì œì˜ ì›ì¸:
     * íŒ¨ëŸ¬ë‹¤ìž„ ë¶ˆì¼ì¹˜ 1: ê°ì²´ì˜ ë™ì¼ì„± vs ë™ë“±ì„±
     * - ê°ì²´ì§€í–¥ ì„¸ìƒ: == ë¹„êµëŠ” ë‘ ê°ì²´ê°€ ë©”ëª¨ë¦¬ ìƒì—ì„œ ê°™ì€ ì¡´ìž¬ì¸ì§€ë¥¼ ë¬»ëŠ”ë‹¤.
     * - ë°ì´í„°ë² ì´ìŠ¤ ì„¸ìƒ: role_id = 1ì´ë¼ëŠ” ì¡°ê±´ì€ "ê°’ì´ ê°™ì€ ë°ì´í„°"ë¥¼ ì˜ë¯¸í•œë‹¤.
     *
     * JDBCë¥¼ ì‚¬ìš©í•˜ë©´ DBì—ì„œ ì¡°íšŒí•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ Roles ê°ì²´ë¥¼ ë©”ëª¨ë¦¬ì— ë§Œë“¤ê¸° ë•Œë¬¸ì—
     * ê°’ì€ ê°™ì§€ë§Œ(ë™ë“±ì„±), ì„œë¡œ ë‹¤ë¥¸ ì¡´ìž¬(ë™ì¼ì„± X)ê°€ ë˜ì–´ë²„ë¦°ë‹¤.
     *
     * ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ì§€ ì•Šìœ¼ë©´:
     * ë§Œì•½ roles ê°ì²´ì˜ ì´ë¦„ì„ ë°”ê¾¸ê³  DBì— ì €ìž¥í•œ ë’¤, ì•„ë¬´ê²ƒë„ ëª¨ë¥´ëŠ” roles2 ê°ì²´ë¥¼ ë‹¤ì‹œ ì €ìž¥í•˜ë©´
     * "roles"ì˜ ë³€ê²½ì‚¬í•­ì´ ë®ì–´ì”Œì›Œì§€ëŠ” ë”ì°í•œ ë°ì´í„° ë¶ˆì¼ì¹˜ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.
     *
     * JPAëŠ” ì´ê²ƒì„ ì–´ë–»ê²Œ í•´ê²°í•˜ëŠ”ì§€ ì´í•´í•˜ëŠ” ê²ƒì´ ì´ë²ˆ ëª¨ë“ˆì˜ í•µì‹¬ì´ë‹¤.
     * @param args
     */
    public static void main(String[] args) {
        Roles roles = getRoles(1);
        Roles roles2 = getRoles(1);

        System.out.println(roles); // Roles@1e0b4072
        System.out.println(roles2); // Roles@791f145a

        System.out.println("IDê°€ 1ì¸ ë‘ Role ê°ì²´ëŠ” ê³¼ì—° ê°™ì€ ì¡´ìž¬ì¼ê¹Œìš”? => " + (roles == roles2)); // false

    }

    private static Roles getRoles(int roleId) {
        String sql = "SELECT role_id, role_name FROM roles WHERE role_id = ?";

        try(Connection conn = dataSource.getConnection();
            PreparedStatement pstmt = conn.prepareStatement(sql)
        ) {
            pstmt.setInt(1, roleId);
            ResultSet rs = pstmt.executeQuery();

            if (rs.next()) {
                Roles role = new Roles();
                role.setRoleId(rs.getInt("role_id"));
                role.setRoleName(rs.getString("role_name"));
                return role;
            } else {
                return null;
            }
        } catch (SQLException e) {
            throw new RuntimeException("Failed to retrieve role with role_id "+ roleId, e);
        }
    }
}
